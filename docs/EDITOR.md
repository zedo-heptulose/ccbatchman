# Editor Module

This document describes CCBatchMan's editor module, which handles coordinate and orbital file transfers between dependent jobs.

## Overview

The `editor.py` module provides functions to:
1. Copy XYZ coordinates from a completed job to a dependent job
2. Set up orbital reading for ORCA calculations
3. Update input files to reference the transferred files

This module is used by `batch_runner.py` to handle job dependencies at runtime.

## Functions

### `replace_xyz_file(input_path, xyz_path, program)`

Copy an XYZ file to a job directory and update the input file to reference it.

**Parameters:**
- `input_path` - Full path to the input file to modify
- `xyz_path` - Full path to the source XYZ file
- `program` - Program type: `'ORCA'`, `'Gaussian'`, `'xTB'`, or `'pyAroma'`

**Behavior:**
1. Copy the XYZ file to the input file's directory
2. Load the input file using the appropriate `InputGenerator` class
3. Update the `xyzfile` property to reference the copied file
4. Write the modified input file

**Example:**
```python
import editor

# Copy optimized geometry to a single-point calculation
editor.replace_xyz_file(
    '/path/to/sp_job/sp_job.gjf',
    '/path/to/opt_job/opt_job.xyz',
    'Gaussian'
)
```

### `setup_orbital_read(input_path, gbw_path, program)`

Copy a GBW (orbital) file and configure ORCA to read orbitals from it.

**Parameters:**
- `input_path` - Full path to the ORCA input file
- `gbw_path` - Full path to the source .gbw file
- `program` - Must be `'orca'` (only ORCA supported)

**Behavior:**
1. Copy the .gbw file to the input file's directory
2. Load the ORCA input file
3. Add `MORead` keyword if not present
4. Add `%moinp "filename.gbw"` block
5. Write the modified input file

**Example:**
```python
import editor

# Set up orbital transfer for SF-TDDFT
editor.setup_orbital_read(
    '/path/to/sf_tddft/sf_tddft.inp',
    '/path/to/triplet_opt/triplet_opt.gbw',
    'orca'
)
```

**Raises:**
- `ValueError` if program is not 'orca'

## Integration with Batch Runner

The batch runner calls these functions when processing jobs with dependencies:

```python
# From batch_runner.py

# Coordinate transfer (all programs)
if row['coords_from'] and row['xyz_filename']:
    xyz_source_dir = resolve_dependency_path(row['coords_from'], job_dir)
    xyz_path = os.path.join(xyz_source_dir, row['xyz_filename'])
    editor.replace_xyz_file(input_path, xyz_path, program)

# Orbital transfer (ORCA only)
if row['orbitals_from'] and row['gbw_filename']:
    gbw_source_dir = resolve_dependency_path(row['orbitals_from'], job_dir)
    gbw_path = os.path.join(gbw_source_dir, row['gbw_filename'])
    editor.setup_orbital_read(input_path, gbw_path, program)
```

## Dependency Specification

Dependencies are specified in the batchfile (generated by `WorkflowGenerator`):

| Column | Description |
|--------|-------------|
| `coords_from` | Relative path to job providing coordinates (e.g., `../opt_job`) |
| `xyz_filename` | Name of XYZ file to copy (e.g., `opt_job.xyz`) |
| `orbitals_from` | Relative path to job providing orbitals |
| `gbw_filename` | Name of GBW file to copy (e.g., `opt_job.gbw`) |

## Supported Programs

| Program | Coordinate Transfer | Orbital Transfer |
|---------|-------------------|------------------|
| ORCA | Yes | Yes |
| Gaussian | Yes | No (uses checkpoint) |
| xTB | Yes | No |
| pyAroma | Yes | No |

## How Input Files Are Modified

### ORCA

The `ORCAInput.xyzfile` property is updated:
```
# Before
* xyzfile 0 1 original.xyz

# After  
* xyzfile 0 1 optimized.xyz
```

For orbital reading, keywords and blocks are added:
```
# Added keyword
! MORead ...

# Added block
%moinp "source.gbw"
```

### Gaussian

The xyz coordinate section is replaced with the new geometry:
```
# The geometry section is rewritten with new coordinates
0 1
C    0.000000    0.000000    0.000000
H    0.000000    0.000000    1.089000
...
```

## Notes

- The module uses `input_generator` classes for file manipulation
- Files are always copied (not moved) to preserve sources
- Input files are completely rewritten when modified
- Orbital transfer is only implemented for ORCA (Gaussian uses checkpoint files differently)
